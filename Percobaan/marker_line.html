<!DOCTYPE html>
<html>
<head>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=geometry"></script>

</head>

<body>
<div id="googleMap" style="width:1200px;height:600px;"></div>
<a href="javascript:location.reload(true)">Reload</a>

<script>
xmlhttp=new XMLHttpRequest();
xmlhttp.open("GET","map.xml",false);
xmlhttp.send();
xmlDoc=xmlhttp.responseXML;

// List
function Neighbor(vnum, nbr){
    this.vertexNum = vnum;
    this.next = nbr;
}

function Node(id, neighbors){
    this.id = id;
    this.adjList = neighbors;
}

function isHighway(way,index){
	var tag = way[index].getElementsByTagName("tag");
	for (hg=0;hg<tag.length;hg++)
	{
		if(tag[hg].getAttribute('k') == "highway"){
			return true;
		}
	}
	return false;
}

function indexForName(adjLists,id) {
	for (var i=0; i < adjLists.length; i++){
		if (adjLists[i].id == id){
			return i;
		}
	}
	return -1;
}

function Graph(node,way){
	var adjLists = [];
	var nd;
	
	for(v=0; v < node.length; v++){
		adjLists.push(new Node(node[v].getAttribute('id'),null));
	}
	
	for (i=0;i<way.length;i++)
	{
		nd = way[i].getElementsByTagName("nd");
		if(isHighway(way,i)){
			for (j=0;j<nd.length-1;j++)
			{
				v1 = indexForName(adjLists,nd[j].getAttribute('ref'));
				v2 = indexForName(adjLists,nd[j+1].getAttribute('ref'));

				adjLists[v1].adjList = new Neighbor(v2, adjLists[v1].adjList);
				adjLists[v2].adjList = new Neighbor(v1, adjLists[v2].adjList);
			}
		}
	}	
	return adjLists;
}

var node = xmlDoc.getElementsByTagName("node");
var way = xmlDoc.getElementsByTagName("way");

var list = new Graph(node,way);



// Generate Map
function getLatByAtt(str)
{
	for (n=0;n<node.length;n++)
	{
		if(node[n].getAttribute('id') == str)
		{
			return node[n].getAttribute('lat');
		}
	}
}
function getLonByAtt(str)
{
	for (m=0;m<node.length;m++)
	{
		if(node[m].getAttribute('id') == str)
		{
			return node[m].getAttribute('lon');
		}
	}
}

function isHighway(way,index){
	var tag = way[index].getElementsByTagName("tag");
	for (hg=0;hg<tag.length;hg++)
	{
		if(tag[hg].getAttribute('k') == "highway"){
			return true;
		}
	}
	return false;
}

var currentId = 0;
var uniqueId = function() {
    return ++currentId;
}

var mapProp = {
	center:new google.maps.LatLng(-6.906845432118958,107.59851515293121),
	zoom:17,
	mapTypeId:google.maps.MapTypeId.ROADMAP
};

var map=new google.maps.Map(document.getElementById("googleMap"),mapProp);

var path = []; 
var markers = {};
var nd,marker,line,content,id;
var lat1,lon1,lat2,lon2;
var image = 'icon/dot_blue.png';

for (i=0;i<way.length;i++)
{
	nd = way[i].getElementsByTagName("nd");
	if(isHighway(way,i))
	{
		id = uniqueId();
		marker = new google.maps.Marker({
			id: id,
			position: new google.maps.LatLng(getLatByAtt(nd[0].getAttribute('ref')), getLonByAtt(nd[0].getAttribute('ref'))),
			map: map,
			icon: image,
		});
		markers[id] = marker;
		
		content = 'Id Node : '+nd[0].getAttribute('ref')+'<br>'+
			'Index Node :'+indexForName(list,nd[0].getAttribute('ref'))+'<br>'+
			'<a href="#" onclick="setAsal(\'' + id + '\')">Pilih sebagai asal</a>'+'<br>'+
			'<a href="#" onclick="setTujuan(\'' + id + '\')">Pilih sebagai tujuan</a>';
			
		addInfoWindow(marker, content);
		
		for (j=0;j<nd.length-1;j++)
		{
			id = uniqueId();
			marker = new google.maps.Marker({
				id: id,
				position: new google.maps.LatLng(getLatByAtt(nd[j+1].getAttribute('ref')), getLonByAtt(nd[j+1].getAttribute('ref'))),
				map: map,
				icon: image,
			});
			markers[id] = marker;
			
		
			content = 'Id Node : '+nd[j+1].getAttribute('ref')+'<br>'+
			'Index Node : '+indexForName(list,nd[j+1].getAttribute('ref'))+'<br>'+
			'<a href="#" onclick="setAsal(\'' + id + '\')">Pilih sebagai asal</a>'+'<br>'+
			'<a href="#" onclick="setTujuan(\'' + id + '\')">Pilih sebagai tujuan</a>';
			
			addInfoWindow(marker, content);

			line = new google.maps.Polyline({
				path: [new google.maps.LatLng(getLatByAtt(nd[j].getAttribute('ref')), getLonByAtt(nd[j].getAttribute('ref'))),
				new google.maps.LatLng(getLatByAtt(nd[j+1].getAttribute('ref')), getLonByAtt(nd[j+1].getAttribute('ref')))],
				strokeColor: "#000000",
				strokeOpacity: 1.0,
				strokeWeight: 3,
				map: map
			});
		}	
	}
}

function addInfoWindow(marker, message) {
    var infoWindow = new google.maps.InfoWindow({
        content: message
    });

	google.maps.event.addDomListener(marker, 'click', function () {
		infoWindow.open(map, marker);
	});
}

var isAsalClicked = false;
var isTujuanClicked = false;
var asal,tujuan;

function setAsal(id){
	if(!isAsalClicked){
		markers[id].setIcon('icon/dot_green.png');
		isAsalClicked = true;
		asal = id;
	}else{
		markers[asal].setIcon('icon/dot_blue.png');
		markers[id].setIcon('icon/dot_green.png');
		asal = id;
	}
}

function setTujuan(id){
	if(!isTujuanClicked){
		markers[id].setIcon('icon/dot_red.png');
		isTujuanClicked = true;
		tujuan = id;
	}else{
		markers[tujuan].setIcon('icon/dot_blue.png');
		markers[id].setIcon('icon/dot_red.png');
		tujuan = id;
	}
}


</script>
</body>

</html> 